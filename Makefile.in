##########################################################################
#
# This is the Makefile for the GroovX project -- if this file has the name
# "Makefile.in", then it is a template for the real Makefile, so to
# generate the real Makefile, run the "configure" script.
#
# Copyright (c) 1998-2003 Rob Peters <rjpeters at klab dot caltech dot edu>
#
# $Id$
#
# --------------------------------------------------------------------
#
# This file is part of GroovX.
#
# GroovX is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free
# Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# GroovX is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.
#
# You should have received a copy of the GNU General Public License along
# with GroovX; if not, write to the Free Software Foundation, Inc., 59
# Temple Place, Suite 330, Boston, MA 02111-1307 USA.
#
##########################################################################

default: all

MAKEFLAGS += --warn-undefined-variables

#-------------------------------------------------------------------------
#
# Import variables generated by the configure script
#
#-------------------------------------------------------------------------

PACKAGE_NAME    := @PACKAGE_NAME@
PACKAGE_TARNAME := @PACKAGE_TARNAME@
PACKAGE_VERSION := @PACKAGE_VERSION@
prefix          := @prefix@
exec_prefix     := @exec_prefix@
matlab_lib      := @matlab_lib@
CXX             := @CXX@
SHLIB_CMD       := @SHLIB_CMD@
STATLIB_CMD     := @STATLIB_CMD@
OBJEXT          := @OBJEXT@
LIB_SUFFIX      := @LIB_SUFFIX@
SHLIB_EXT       := @SHLIB_EXT@
STATLIB_EXT     := @STATLIB_EXT@
CPPFLAGS        := @CPPFLAGS@
CXXFLAGS        := @CXXFLAGS@
DEFS            := @DEFS@
LDFLAGS         := @LDFLAGS@
LIBS            := @LIBS@ @X_EXTRA_LIBS@
with_htmldoc    := @with_htmldoc@

LIB_EXT         := $(LIB_SUFFIX).$(SHLIB_EXT)

#-------------------------------------------------------------------------
#
# Directories for different file types
#
#-------------------------------------------------------------------------

BUILD := build
SRC := src
DEP := $(BUILD)/dep
OBJ := $(BUILD)/obj
LOGS := ./logs
DOC := ./doc
SCRIPTS := ./scripts
VISX_LIB_DIR := $(exec_prefix)/lib/visx

#-------------------------------------------------------------------------
#
# Rules to rebuild files from the configure script
#
#-------------------------------------------------------------------------

configure: configure.in
	autoconf

config.status: configure
	./config.status --recheck

Makefile: Makefile.in config.status
	./config.status --file=Makefile:Makefile.in

$(DOC)/DoxyConfig: $(DOC)/DoxyConfig.in config.status
	./config.status --file=$(DOC)/DoxyConfig:$(DOC)/DoxyConfig.in

#-------------------------------------------------------------------------
#
# Build rules for object files
#
#-------------------------------------------------------------------------

# This build rule helps to create subdirectories that don't need to be part of
# the CVS repository, but do need to exist to hold generated files during the
# build process in sandboxes..
%.timestamp:
	@[ -d ${@D} ] || mkdir -p ${@D}
	@[ -f $@ ] || touch $@

CPPFLAGS += -I$(SRC)

ALL_CXXFLAGS := $(CXXFLAGS) $(CPPFLAGS) $(DEFS) \
	-DVISX_LIB_DIR=\"$(VISX_LIB_DIR)\"

$(OBJ)/%.$(OBJEXT) : $(SRC)/%.cc
	@[ -d ${@D} ] || mkdir -p ${@D}
	@echo $< >> $(LOGS)/CompileStats
	@echo ""
	time $(CXX) $(ALL_CXXFLAGS) \
		-c $< \
		-o $@

# to avoid deleting any intermediate targets
.SECONDARY:

$(SRC)/%.cc.E : $(SRC)/%.cc
	time $(CXX) -E $< $(ALL_CXXFLAGS) > $@

$(SRC)/%.cc.E : $(SRC)/%.h
	echo "#include \"$<\"" > temp.cc
	time $(CXX) -E temp.cc $(ALL_CXXFLAGS) > $@
	rm temp.cc

#-------------------------------------------------------------------------
#
# Build rules for static and dynamic libraries
#
#-------------------------------------------------------------------------

%.$(SHLIB_EXT):
	@[ -d ${@D} ] || mkdir -p ${@D}
	time $(SHLIB_CMD) $@ $(LDFLAGS) $^ $(LIBS)

%.$(STATLIB_EXT):
	@[ -d ${@D} ] || mkdir -p ${@D}
	time $(STATLIB_CMD) $@ $^

#-------------------------------------------------------------------------
#
# Dependencies 
#
#-------------------------------------------------------------------------

# This `find` command gets run just once, when the makefile is loaded.
ALL_SRCS := $(shell find $(SRC) -name \*.h -or -name \*.cc)

# dependencies of object files on source+header files

$(SCRIPTS)/cppdeps: $(SCRIPTS)/cppdeps.cc
	$(CXX) -O2 -Wall $^ -o $@

$(DEP)/cppdepends: $(SCRIPTS)/cppdeps $(DEP)/.timestamp $(ALL_SRCS)
	time $(SCRIPTS)/cppdeps.tcl --src $(SRC) --objdir $(OBJ)/ > $@
	time $(SCRIPTS)/cppdeps --src $(SRC) --objdir $(OBJ)/ |sort> $(DEP)/altdeps
	diff $@ $(DEP)/altdeps

# dependencies of package shlib's on object files

$(DEP)/pkgdepends: $(DEP)/.timestamp $(VISX_LIB_DIR)/.timestamp \
		$(ALL_SRCS) src/pkgs/buildPkgDeps.tcl
	src/pkgs/buildPkgDeps.tcl \
		--depfile $@ \
		--objdir $(OBJ)/pkgs \
		--objext $(OBJEXT) \
		--pkgdir $(SRC)/pkgs \
		--libdir $(VISX_LIB_DIR)

$(VISX_LIB_DIR)/dlinktest.$(SHLIB_EXT): \
	$(exec_prefix)/lib/libDeepTcl$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT)

$(VISX_LIB_DIR)/fstringtest.$(SHLIB_EXT): \
	$(exec_prefix)/lib/libDeepTcl$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT)

$(VISX_LIB_DIR)/vectwotest.$(SHLIB_EXT): \
	$(exec_prefix)/lib/libDeepTcl$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT)

$(VISX_LIB_DIR)/matlabengine.$(SHLIB_EXT): \
	$(VISX_LIB_DIR)/mtx.$(SHLIB_EXT) \
	$(exec_prefix)/lib/libDeepTcl$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT)

$(VISX_LIB_DIR)/mtx.$(SHLIB_EXT): \
	$(exec_prefix)/lib/libDeepTcl$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT)

ifneq ($(matlab_lib),)
$(VISX_LIB_DIR)/mtx.so: \
	$(matlab_lib)/libmx.so \
	$(matlab_lib)/libmatlb.so

$(VISX_LIB_DIR)/matlabengine.so: \
	$(matlab_lib)/libeng.so \
	$(matlab_lib)/libmx.so \
	$(matlab_lib)/libut.so \
	$(matlab_lib)/libmat.so \
	$(matlab_lib)/libmi.so \
	$(matlab_lib)/libmatlb.so
endif

# dependencies of main project shlib's on object files

LIB_DEP_CMD := 	$(SCRIPTS)/build_lib_rules.tcl \
		--libdir $(exec_prefix)/lib \
		--libprefix libDeep \
		--libext $(LIB_EXT) \
		--srcroot $(SRC) \
		--objroot $(OBJ) \
		--objext .$(OBJEXT) \
		--modules "Visx,Gfx,GWT,Tcl,IO,Gx,System,Util"

$(DEP)/libdepends: $(DEP)/.timestamp $(ALL_SRCS) \
		$(SCRIPTS)/build_lib_rules.tcl
	$(LIB_DEP_CMD) > $@

include $(DEP)/cppdepends $(DEP)/pkgdepends $(DEP)/libdepends

# Need to set up the .LIBPATTERNS variable so that we get the right
# behavior when we specify something like "-lfoo" as a prerequisite.
.LIBPATTERNS = lib%.dylib lib%.so lib%.a

# Here we have all of the inter-library dependencies. These are needed,
# e.g., for Mac OS X to be able to do two-level namespace linking. That
# requires that there be no undefined symbols when creating a shared
# library, and that in turn requires that each shared library be linked
# against all its prerequisites.

$(exec_prefix)/lib/libDeepSystem$(LIB_EXT): \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT)

$(exec_prefix)/lib/libDeepGWT$(LIB_EXT): \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT)

$(exec_prefix)/lib/libDeepTcl$(LIB_EXT): \
	$(exec_prefix)/lib/libDeepGWT$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT) \

$(exec_prefix)/lib/libDeepIO$(LIB_EXT): \
	$(exec_prefix)/lib/libDeepTcl$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT)

$(exec_prefix)/lib/libDeepGx$(LIB_EXT): \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT) \

$(exec_prefix)/lib/libDeepGfx$(LIB_EXT): \
	$(exec_prefix)/lib/libDeepGWT$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepGx$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepIO$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepTcl$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepSystem$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT) \

$(exec_prefix)/lib/libDeepVisx$(LIB_EXT): \
	$(exec_prefix)/lib/libDeepSystem$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepGx$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepIO$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepGfx$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepUtil$(LIB_EXT) \
	$(exec_prefix)/lib/libDeepTcl$(LIB_EXT) \

#-------------------------------------------------------------------------
#
# Build rules for production and debug executables
#
#-------------------------------------------------------------------------

ALL_STATLIBS := $(filter %.$(STATLIB_EXT),$(PROJECT_LIBS))
ALL_SHLIBS   := $(filter %.$(SHLIB_EXT),$(PROJECT_LIBS))

STATIC_OBJS := $(subst .cc,.$(OBJEXT),\
	$(subst $(SRC),$(OBJ), $(wildcard $(SRC)/grsh/*.cc)))

EXECUTABLE := $(exec_prefix)/bin/groovx$(PACKAGE_VERSION)

$(EXECUTABLE): $(exec_prefix)/bin/.timestamp $(STATIC_OBJS) $(ALL_STATLIBS)
	time $(CXX) -o $@ $(STATIC_OBJS) $(LDFLAGS) $(PROJECT_LIBS) $(LIBS)

.PHONY: build install_scripts install check all

# Have to put these components in a strict dependence hierarchy, since some
# versions of make (e.g. under Darwin) don't reliably run targets in their
# order in the dependency list. Thus any specific ordering requirements
# must be reflected explicitly in target-dependency relationships.

build: TAGS $(ALL_SHLIBS) $(PKG_LIBS) $(EXECUTABLE)

install_scripts: $(exec_prefix)/bin/.timestamp
	cp share/scripts/*.tcl $(exec_prefix)/bin

install: install_scripts build
	ln -s -f groovx$(PACKAGE_VERSION) $(exec_prefix)/bin/groovx

check: install
	$(EXECUTABLE) ./testing/grshtest.tcl

all: check

#-------------------------------------------------------------------------
#
# Miscellaneous targets
#
#-------------------------------------------------------------------------

backup:
	tclsh $(SCRIPTS)/Backup.tcl

benchmarks: $(EXECUTABLE)
	$(EXECUTABLE) $(SCRIPTS)/benchmarks.tcl -output $(LOGS)/benchmarks.txt

# Remove all backups, temporaries, and coredumps
neat:
	find . -name \*~ -exec rm -f {} \;
	find . -name \#~ -exec rm -f {} \;
	find . -name .\#\* -exec rm -f {} \;
	rm -f ./expt*2003.asw ./resp*2003 ./core*

# Make neat, and also remove all intermediate build files
cleaner: neat
	find $(BUILD) -follow -type f -exec rm -f {} \;

# Count the lines in all source files
count:
	@wc $(ALL_SRCS) | sort -n | tee $(LOGS)/count

# Count the number of non-commented source lines
ncsl:
	@NCSL $(ALL_SRCS) | sort -n | tee $(LOGS)/ncsl

docs: $(DOC)/DoxyConfig
	mkdir -p $(BUILD)/html
	(time doxygen $(DOC)/DoxyConfig > $(DOC)/DocLog) >& $(DOC)/DocErrors
	time cp -r $(BUILD)/html/* $(with_htmldoc)
	chmod -R og+r $(with_htmldoc)

# Generate tags file based only on header files
H_TAGS: $(ALL_SRCS)
	find $(SRC) -name \*.h | etags - -o $@

obj_sizes:
	ls -lLR $(OBJ) | grep "\.$(OBJEXT)" | sort -n +4 | tee $(LOGS)/obj_sizes

.PHONY: showpid
showpid:
	ps -ef | grep make

# Generate TAGS file based on all source files
TAGS: $(ALL_SRCS)
	find $(SRC) -name \*.h -or -name \*.cc | etags - -o $@

DISTNAME := $(PACKAGE_TARNAME)_$(shell date +%Y%m%d)
CVS_ROOT := $(shell test -e ./CVS/Root && cat ./CVS/Root)
CVS_REPO := $(shell test -e ./CVS/Root && cat ./CVS/Repository)

export:
	echo $(DISTNAME)
	mkdir -p snapshots
	cd snapshots && \
	  cvs -z3 -d $(CVS_ROOT) export -r HEAD -d $(DISTNAME) $(CVS_REPO) \
	  && rm -r $(DISTNAME)/logs/* \
	  && (cd $(DISTNAME) && autoconf) \
	  && tar cvfz $(DISTNAME).tar.gz $(DISTNAME)

www_export: export
	cp snapshots/$(DISTNAME).tar.gz $(HOME)/www/code/
	chmod og+r $(HOME)/www/code/$(DISTNAME).tar.gz
